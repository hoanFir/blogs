
为了提高安全性，浏览器添加了同源策略来限制跨域访问。

Q1：什么是同源？

A2：所谓同源，就是指同域名，同端口，同协议下的资源。


Q2：什么是跨域

Q2：所谓跨域，就是指跨域名，跨端口，跨协议访问资源。

例如，如果有两个服务器，服务器A和服务器B，服务器A上存储了.java，.js，.css等文件，当我们在服务器B上只写了html，然后要在服务器B上动态创建 .js，.css等数据(使用ajax请求)，便向服务器A上请求这些文件，当请求这些文件后，我们再在服务器B上运行html，会发现在服务器B上的运行效果与在服务器A上运行的效果是一样的，这样就是实现了跨域。但由于浏览器的同源策略，一般都是不支持如此跨域请求资源的。


### 一、遵循 CORS protocol

```

为了提高安全性，浏览器添加了同源策略来限制跨域访问。但与此同时也降低了开发的灵活性。为此，浏览器提供了折中方法，即只要遵循 CORS protocol，跨域也可访问。

CORS, cross-origin resource sharing, 即跨域资源共享。

在跨域的情况下，request被分为simple request和preflighted request。

simple request that is always considered authorized and is not explicitly listed in responses to preflight requests，即发送simple request无需先发送OPTIONS请求验证。而在发送preflighted request之前，会先发送OPTIONS请求去验证CORS protocol是否能被understand，来决定是否发送真正的请求。



1. 什么时候称为preflighted request？

满足以下任一条件：

1.1 请求方法为put、delete、connect、options、trace、patch
1.2 请求头不含有CORS-safelisted request header，如Accept, Accept-Language, Content-Language, Content-Type(application/x-www-form-urlencode或multipart/form-data或text/plain)。如某个请求头含有Content-Type: application/xml，因为不是条件里Content-Type指定的三种类型之一，所以这个请求就是一个preflighted request



2. 实现CORS怎么通过服务端来做？

2.1 为response header添加Access-Control-Allow-Origin，表示允许跨域访问。

Access-Control-Allow-Origin: * - 表示任意来源都可以访问
Access-Control-Allow-Origin: http://test.com - 表示来源域名为test.com的可以访问

如果使用了Access-Control-Allow-Credentials: true，就不能使用Access-Control-Allow-Origin: *，即必须指定某个域名。


2.2 如果请求为preflighted request，则还要为response header添加Access-Control-Allow-Methods和Access-Control-Allow-Headers

当由于请求方法的原因，需要设置：
'Access-Control-Allow-Methods': 'OPTIONS, PUT, DELETE, TRACE, PATCH'

当由于request header原因使得请求变成preflighted request，如Content-Type: application/json，需要设置：
'Access-Control-Request-Headers': 'Content-Type'


2.3  如果请求发送了http cookies或者http authentication information，要为response header添加Access-Control-Allow-Credentials：

'Access-Control-Allow-Credentials': true

tips：客户端想要在跨域时发送cookie等信息需要设置withCredentials: true(ajax)或credentials: 'include'(fetch)


```


### 二、其他跨域方法

1. 方式一：利用 <script> 标签 src 属性不受同源策略影响
var oBtn = document.getElementById('btn');
oBtn.onclick = function() {

    /* 不带callback函数 */
    var _script = document.createElement("script");
    _script.src = "http://test.com/api/User.php?user="+_user+"message="+_message;
    _script.type = "text/javascript";

    /* 带callback函数 */
    var script = document.createElement("script");
    script.src = "https://api.douban.com/v2/book/search?q=javascript&count=1&callback=handleResponse";
    document.body.insertBefore(script, document.body.firstChild);   

};




2. 方式二：jQuery jsonp 和 getJSON
jsonp：json with padding，填充式json

/* $.get jsonp */
$(document).ready(function() {
　　$.get("http://10.9.156.108/HTML5/lesson24/test.js", null, function(){}, "jsonp");
});

/* $.ajax jsonp */
$.ajax({
    async: true,
    url: “https://api.douban.com/v2/book/search”,
    type: “GET”,
    datatype: “jsonp”,
    jsonpCallback: “handleResponse”,
    data: {
        a: "", 
        count: 1
    },
    Success: function(res, status, xhr) {
        Console.log(response);
    }
});


/* getJSON */
/* 若不带参数默认不跨域，带了参数则支持跨域 */

$.getJSON("https://api.douban.com/v2/book/search") //默认不跨域

$.getJSON("https://api.douban.com/v2/book/search?callback=?", //加上callback参数支持跨域
    function(data) { console.log(data); });

$.getJSON("https://api.douban.com/v2/book/search?q=javascript&count=1&callback=?", 
    function(data) { console.log(data); });

注意，jsonp 不能发送 post 请求，只要是使用 jsonp 方式，则请求一定是 get 方式，因为本质是 script 方式加载的

jsonp 存在的问题：如果所请求的其他域是不安全的，很可能会在响应中夹带一些恶意代码。



3. 方式三：CORS
CORS 定义一种跨域访问的机制，可以让 AJAX 实现跨域访问，CORS 允许一个域上的网络应用向另一个域提交。

场景：当你在本地开发前端业务，此时需要跟服务器上的后台业务进行数据交互时，本地计算机和远程服务器很明显是不同源的，此时可以让服务器后台的开发者通过 CORS 方式来允许前端的跨域请求：

header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-methods: POST,GET,DELETE,PUT,OPTIONS")



Node JS 实现的后台业务
App.all('*', function(req, res, next) {

	res.header('Access-Control-Allow-Origin', '*');
	res.header('Access-Control-Allow-Headers', 'Content-Type, Content-Length, Authorization, Accept, X-Requested-With, yourHeaderFeild');
	res.header('Access-Control-Allow-Methods', 'PUT, POST, GET, DELETE, OPTIONS');

	if(req.method == 'OPTIONS') { // options请求是查看服务端支持什么方式的请求
		res.send(200);
	} else {
		next();
	}
})



4. 方式四：配置代理
我们在使用如 vue、react 等前端框架开发时，会发现它们在前后端分离的前提下，实现跨域请求的方式是在配置文件中添加代理。具体可以根据具体应用谷歌。
