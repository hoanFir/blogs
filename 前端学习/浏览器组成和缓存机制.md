🐾 浏览器组成和缓存机制

🕘 2019.12.16 由 hoanfirst 编辑（原作者：JD_yxl）

### 一、认识浏览器组成

浏览器由用户界面（User Interface）、浏览器引擎（Browser Engine）、渲染引擎（Rendering Engine）、网络（Networking）、用户界面后端（display Backend）、JS解释器/JS引擎（JavaScript Interpreter）、数据存储（Data Persistence）组成。

1. User Interface

用户界面包括工具栏、地址栏、前进/后退/刷新按钮、书签、首选项、打印等窗口上除了网页显示区域以外的部分。


2. Browser Engine

在用户界面和渲染引擎之间传送指令，即提供给用户界面查询和操作渲染引擎的接口。


3. Rendering Engine

负责显示请求的内容，解析返回的数据显示在屏幕上。一般称渲染引擎为浏览器内核，其实这不严谨，浏览器内容应该是渲染引擎和js解释器两部分，只是因为js解释器越来越独立，目前主流的渲染引擎主要有Webkit、Blink、Gecko和Trident等。

```

渲染引擎工作流程：

请求返回的html数据通过浏览器的网络层到达渲染引擎后，渲染工作就开始了，注意，每次渲染不会超过8K的数据，也就是说，这个过程是逐步完成的。浏览器为了更好的用户体验，渲染引擎会尽可能早的将内容呈现到屏幕上（比如呈现一张图片是从上往下慢慢显示的），并不是等到所有的html都解析完成之后再去构建(construct)和布局(layout)render树，它是解析完一部分内容就显示一部分内容，同时可能还会通过网络下载其余内容。

基本流程：

parsing html to construct the dom tree -> render tree construction -> layout the render tree -> parsing the render tree. 

即先使用HTML解析器解析html构建dom树，再根据css解析生成cssom树，两者共同构建render树；接着，布局render树，对render树的每个节点确定其在屏幕上的位置；最后遍历render树，进行绘制。

```


4. Networking

用于网络请求，如http请求。它包括：与平台无关的接口和各平台独立的底层实现。


5. Display Beckend

用于绘制基础组件，如组合选择框及对话框等浏览器基本组件，具有不特定于平台的通用接口。


6. JavaScript Interpreter

用来解析和执行js代码。


7. Data persistence

将与浏览器会话相关联的各种数据存储在硬盘上，比如书签、工具栏设置等高级数据，或者Cookie、安全证书、缓存等低级数据。另外，HTML5定义了web database技术，这是一种轻量级完整的客户端存储技术。


### 二、浏览器缓存机制

在浏览器的渲染引擎解析HTML，加载资源（js/css/img）时，不同的渲染引擎对数据获取的流程和存储规则都不同，这就导致不同平台上的浏览器加载代码时，有的会使用缓存数据，有的会重新加载，有的加载速度快，有的加载速度慢。

首先，以`webkit rendering engine`为例：

#### 2.1 webkit rendering engine对资源的加载分为3类加载器

1. 特定资源加载器：该类资源加载器只加载某一种资源

如HTML文本/HTML Loader、CSS文本/CSS Style Sheet Loader、字体/Font Loader、图片/Image Loader、只读资源/Raw Resource Loader、JavaScript脚本/Script Loader


2. 缓存机制的资源加载器：CachedResource

特定资源加载器会共享CacheResource来读取和存入缓存资源


3. 通用资源加载器：ResourceLoader

负责从文件系统或网络加载资源来获取数据，同样可被特定资源加载器共享


#### 2.2 webkit rendering engine对资源的加载有两条路径

1. 主资源的加载，即HTML文本

2. 子资源的加载，如img标签

示例：

```

首先，加载主资源，通过 HTML 解析器解析 HTML ，当遇到 <img> 标签时，开始进行子资源的加载 ->

webkit 首先会调用 ImageLoader 特定的图片资源加载器，异步加载图片数据 -> 

ImageLoader 会先调用 cacheResourceLoader 去查看浏览器缓存情况，Memory Cache 或 Disk Cache 中有相应的资源并可用，则使用缓存数据，否则通过RequestLoader 调用webkit 网络模块发起网络请求，返回网络资源，并通过 cacheResourceLoader 将数据缓存，主要是存储在 Memory Cache 或 Disk Cache 中，方便再次调用

```

#### 2.3 为什么引入缓存

加载图片等一些资源时的过程是异步的，这不影响页面渲染速度。但是，并不是加载所有的子资源都是异步的，比如解析js脚本或者发起http请求，都会使得html解析器立即停止，直至脚本执行完毕或请求资源全部返回才继续解析。

**上述的同步执行过程，严重影响页面的渲染速度。**而且，对于一些`静态资源`或者`较长时间才会更新的后台数据`，它们的更新频率是很低的，如果每次都发起网络请求，不仅性能低，还使得用户体验差，因此为了提高数据响应和页面渲染的性能，引入了缓存机制。


### 3. 缓存的位置




