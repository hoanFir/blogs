


## 一、OAuth

小程序和微信是一种类似应用与平台的关系，小程序属于微信公众平台，同一个平台下还有微信公众号：在技术角度上，小程序与微信的关系比公众号更密切，因为公众号的文章本质上是一个 H5 网页，对微信底层的依赖比小程序弱；从产品角度上，二者与微信的关系一致，都是运行在微信平台上的第三方应用。

既然小程序是微信平台的第三方应用，那么在接入微信登录时就要严格遵守官方的接入规范。**而在互联网技术领域，对于支持第三方应用接入的平台，在登录授权上有一套标准的技术规范：OAuth 2.0**。

关于OAuth/OAuth2.0，可通过阅读[OAutho原理](https://github.com/hoanFir/blogs/blob/master/%E5%B7%A5%E7%A8%8B/OAuth%E5%8E%9F%E7%90%86.md)学习。

> OAuth2.0解决了一个问题：小A向小B借了东西忘了还，某天小B着急要用，但是小A不在家，但好在小A家的门锁是智能门锁，可以将密码告诉小B让他自己去小A=家里取。但是小A本着“防人之心不可无”的心理，担心小B是否会趁机记下甚至修改你家的门锁密码。左右为难的时候，小A突然想起来智能门锁可以创建临时密码，这种临时密码只能在 10 分钟之内有效，而且没有修改原本密码的权限。这样就解决了被其他人入室的安全问题。简单概括就是：OAuth 2.0是一个授权机制，资源所有者告诉认证服务器，临时授予某个第三方应用访问资源服务器获取资源的权限，认证服务器给第三方应用颁发一个临时令牌，拥有这个令牌便可以获取资源数据，一旦令牌过期或失效便收回权限。



## 二、小程序登录流程

开发小程序的时候，都会涉及到小程序token，而 OAuth 2.0 规范中的令牌，与**小程序登录场景下的 token**作用是一致的，只不过 OAuth 规范只定义了令牌的作用，并没有限制它的具体使用方法，那微信（认证服务器）是怎么实现让用户（资源所有者）授权后使得微信小程序（第三方应用）可以访问用户放在微信服务器（资源服务器）上的用户信息呢？即微信遵循 OAuth 规范前提下的具体实践是什么？

### 2.1 使用微信登录的优势

小程序并没有强制要求只能使用微信登录，开发者完全可以跟 Web 网站一样使用用户名、邮箱等登录方式。但是使用微信登录的优势非常明显：

- 从生态系统的角度上， 相对于其他应用端，以微信为入口的小程序最大的优势是拥有微信完善的生态系统，用户使用微信登录后可以使用微信提供给小程序的各种平台级能力，比如订阅消息、微信支付等。

- 从用户体验的角度上， 用户能够很大程度上降低登录的复杂程度。想象一下，对比在小程序内用用户名密码登录和一键微信登录，哪种方式更容易被用户接受呢？结果不言而喻。

- 从产品策略的角度上， 使用微信登录小程序能够根据用户的来源，制定特殊的产品策略，比如对于小程序的用户发放专属的优惠券。

所以，你可以由此得出小程序使用微信登录的三个主要优势：融入微信生态；提高用户体验；制定产品策略。


### 2.2 小程序登录具体实践

先看一张小程序官方文档登录的时序图：

![](https://res.wx.qq.com/wxdoc/dist/assets/img/api-login.2fcc9f35.jpg)


整个登录流程中描述了三种角色和六个术语。



- 三种角色

客户端（小程序）、开发者服务器、微信接口服务（微信处理登录请求的服务）。

客户端在整个登录流程中主要承担两种行为：作为整个流程的发起者，获取临时登录凭证 code；作为整个流程的终结者，存储登录态令牌 token。

注意，客户端的所有信息和网络请求几乎都是可以被破解或拦截的，所以出于安全的考虑，小程序登录流程中的一些接口被限制不能在客户端中直接调用，而是需要在开发者服务端发起，开发者服务器的工作便是处理这些安全敏感的网络请求，体现为上图中使用客户端传过来的 code 获取 openid 和 session_key 的请求，这个请求使用了微信提供的 `auth.code2Session` 接口。

而微信接口服务的工作对于开发者来说是不透明的，你需要做的仅仅是根据接口的规范，组装网络请求发送给它，然后根据返回执行分发逻辑。微信服务器会验证网络请求的合法性，对于合法请求下发密钥 session_key 和用户 openid。

- 六个术语

code（临时登录凭证）、appid（小程序ID）、appsecret（小程序密钥）、openid（登录成功后用户的唯一ID）、session_key（对用户数据进行加密签名的密钥）、token（登录态令牌）。


code，它是在客户端（即小程序）内通过 `wx.login` API 获取的，然后通过 HTTP 请求发送给开发者服务器。code 的作用体现在“临时”两字上，它的有效期限仅有 5 分钟，并且仅能够使用一次（即请求一次 `auth.code2Session` 接口）。

appid，每个微信小程序在创建之后（即在微信公众平台注册并初始化完成）便同时生成了appid，这个 ID 标记了小程序的唯一性，等同于网站的URL（经过备案的）、App 的包名等标记应用唯一性的信息。

appsecret，它是小程序的密钥，可以在微信公众平台的后台管理系统中获取。appsecret 是非常私密的信息，所以微信在制定小程序登录的流程时，将携带此信息的网络请求限制在只能通过开发者服务器发送给微信接口服务，这样对于客户端来说是不可见的，进而降低了被泄露的可能性。与appid 不同的是，appsecret 可以被重置，但每次重置之后，历史的 appsecret 便会失效，所以请谨慎操作。

openid，很多开发者容易走入一个误区，误将 openid 理解为用户的唯一 ID。这句话如果放在某个小程序的特定语境下是没有问题的，但是如果放在微信生态的全局角度上是错误的。为什么呢？微信对于用户openid的定义是：微信号在某个应用程序（公众平台的小程序、公众平台的公众号、接入开放平台的应用）中的唯一id。而在微信生态下，通过UnionId来作为用户的唯一Id，及UnionId可以用来关联不同应用程序中各个openid，比如同一个微信号在小程序和公众号内需要配置同样的权限，仅通过 openid 无法实现，便需要获取此微信号的 UnionId。

session_key，是对用户数据进行加密签名的密钥，微信服务器使用它将用户的数据进行加密和解密。你可以简单地将 session_key 理解为获取用户数据的“绿卡”，登录之后所有涉及访问微信服务器的请求一般都需要带上它，微信服务器会校验 session_key 的合法性。

其实到这一步（即拿到了 openid 和 session_key）已经完成了小程序的登录流程，但对于一个应用程序来说，用户进行登录操作应该是“一劳永逸”的，即登录过一次之后在一定时间之内的后续操作都不需要再次登录，用技术语言描述就是应该保存用户的登录态。这个时候就需要用到接下来的一个术语：token。

token，登录态是个逻辑词汇，token 可以理解为登录态的具象化、数据化。在小程序的登录流程图中，你可以看出，token是由开发者服务器创建的一个字符串，而且需要跟 openid 和 session_key 相关联。其实这里并不是强制关联 openid，因为 openid 并不算是私密信息，可以放心地下发到客户端（即小程序）。但是 session_key 是非常私密的信息，一旦泄露有很大的安全隐患，所以强烈建议不要把它下发到客户端。

在获取到 openid 和 session_key 之后，开发者服务器创建一个 token，然后与 openid 和session_key 进行关联，具体的方法根据服务器编程语言的不同有多种实现方案。以JavaScript 语言作为示例，可以创建一个对象，对象的 key 是 token 的值，value 是一个包含 openid 和 session_key 的对象，如下：

```javascript
{
    "token_1": {
        "openid": "获取到的openid 1",
        "session_key": "获取到的session_key 1"
    }，
    "token_2": {
        "openid": "获取到的openid 2",
        "session_key": "获取到的session_key 2"
    }，
}
```

关联完成之后开发者服务器将 token下发到客户端，客户端保存在本地，后续的所有请求均需要携带此 token，携带的方法并没有既定的规范，可以通过 URL Query、HTTP Body、Header 等，但通常建议通过 Header 传递，这样相对来说更安全一些。

讲到这儿，小程序接入微信登录的全部流程便讲解完成了。
