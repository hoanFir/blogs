🐾 组件懒加载的四种方式

🕘 2019.10.30 由 hoanfirst 编辑

懒加载/按需加载。在客户端导航至该模块页面时，才发起请求获取模块包。

通过按需加载一个独立模块的组件

### webpack + es6 import + this.props.children

### webpack + es6 import + higher order component(pure)

### webpack + es6 import + async(higher order funtion)

### webpack + common.js require.ensure


### 使用bundle-loader

bundle-loader是require.ensure的封装，类似于AMD(asynchronous module define)模块化规范。

webpack.config.base.js

```javascript

module.exports = {
    output: {
        chunkFilename: 'chunk/[name].js'
    },
}

```

app/index.js

```javascript

import MyRouter from '../router';

class MyPlatform extends React.Component {
    constructor() {
        super();
    }
    render() {
        return (
            <HashRouter>
                <Layout className="layout">
                
                    <SideNav collapsed={collapsed}/>
                    
                    <Layout style={{ marginLeft: collapsed? 80 : 200 }}>
                        <Header className="layout-header"></Header>
                        <Content className="layout-content">
                            <MyRouter/>
                        </Content>
                    </Layout>
                    
                </Layout>
            </HashRouter>
        );
    }
}

```

router/index.js

```javascript

import React, { Component } from 'react';
import { bindActionCreators } from 'redux';
import { connect } from 'react-redux';
import { Route } from 'react-router-dom';

import Home from '../pages/home';

import Bundle from '../components/Bundle';

import UserManage from 'bundle-loader?lazy&name=user_page!../pages/userManage';

import AssistantData from 'bundle-loader?lazy&name=app_data!../pages/assistantData';
import ProductData from 'bundle-loader?lazy&name=app_data!../pages/ProductData';
import DialogData from 'bundle-loader?lazy&name=app_data!../pages/DialogData';

class MyRouter extends Component {
    constructor() {
        super();
        this.state = {
            routes: [
                //home page
                {
                    path: '/home_page',
                    key: 'home_page',
                    component: Home,
                    auth: true,
                },
                //user manage
                {
                    path: '/user_page',
                    key: 'user_page',
                    component:  (props) => <Bundle load={UserManage}>{(Com) => <Com {...props}/>}</Bundle>,
                    auth: true,
                },
                //data manage
                {
                    path: '/smart_assist_data',
                    key: 'smart_assist_data',
                    component: (props) => <Bundle load={AssistantData}>{(Com) => <Com {...props}/>}</Bundle>,
                    auth: true,
                },
                {
                    path: '/product_data',
                    key: 'product_data',
                    component: (props) => <Bundle load={ProductData}>{(Com) => <Com {...props}/>}</Bundle>,
                    auth: true,
                },
                {
                    path: '/dialog_data',
                    key: 'dialog_data',
                    component: (props) => <Bundle load={DialogData}>{(Com) => <Com {...props}/>}</Bundle>,
                    auth: true,
                },
            ]
        }
    }
    
    render() {
        return {
            let routes = this.state.routes.map(item=>{
                if(item.auth) {
                    return <Route
                        exact={item.path === '/' ? true : false}
                        key={item.key}
                        path={item.path}
                        component={item.component}
                    />
                }
            })
        }
    }

}

const mapStateToProps = (state) => {
    return {
        menus: state.menu.menus,
    };
};

const mapDispatchToProps = (dispatch) => {
    return {
        actions: bindActionCreators({
            ...LeftMenuActions,
        }, dispatch)
    };
};
module.exports = connect(mapStateToProps, mapDispatchToProps, undefined, {withRef: true, pure: false})(MyRouter);

```


/components/Bundle/index.js

```javascript

import React from 'react';

class Bundle extends React.Component {
    constructor() {
        super();
        
        this.state = {
            //由于module被占用了
            modul: null
        };
    }
    
    componentDidMount() {
        this.load(this.props);
    }
    
    componentWillReceiveProps(nextProps) {
        //load different module
        if(nextProps.load !== this.props.load) {
            this.load(nextProps);
        }
    }
    
    load(props) {
        this.setState({
            modul: null
        });
        
        //bundle-loader
        //import UserManage from 'bundle-loader?lazy&name=user_page!../pages/userManage';
        //eg: load={userManage}
        //传入一个回调，在加载成功之后执行
        props.load((modul) => {
            this.setState({
                //兼容es module 和 amd module
                modul: modul.default ? modul.default : modul
            });
        });
    }
    
    
    render() {
        return this.state.modul ? this.props.children(this.state.modul) : <span>loading...</span>;
    }
}

export default Bundle;

```
